var MapsService=new function(){"use strict";var e,t,n=this,a=[];n.getMap=function(){return e},n.getInfoWindow=function(){return t},n.getMarkers=function(){return a},n.clearMarkers=function(){a.forEach(function(e){e&&e.setMap(null)}),a=[]},n.createMarker=function(a){var r=new google.maps.Marker({position:new google.maps.LatLng(a.venue.location.latitude,a.venue.location.longitude),animation:google.maps.Animation.DROP});return r.setMap(e),google.maps.event.addListener(r,"click",function(){n.bounceOnce(this),t.setContent(n.createInfoWindowContent(a)),t.open(e,this)}),r},n.fitBounds=function(){var t=new google.maps.LatLngBounds;if(a.length>0){for(var n=0;n<a.length;n++)a[n].getVisible()&&t.extend(a[n].getPosition());e.fitBounds(t)}},n.bounceOnce=function(e){e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1400)},n.createInfoWindowContent=function(e){var t='<div class="mdl-card">';return t+='<div class="mdl-card__title" style="background: url(@@eventImage@@) center / cover">',t+='<h2 class="mdl-card__title-text">@@name@@</h2>',t+="</div>",t+='<div class="mdl-card__supporting-text">',t+="<strong>Headliner: @@eventHeadliner@@</strong>",t+="<br/>",t+="<span>@@venueName@@</span>",t+="<br/>",t+="<span>@@venueCity@@, @@venueCountry@@</span>",t+="<br/>",t+="<span>@@attendance@@ going</span>",t+='<span class="pull-right">Powered by <a target="_blank" href="http://www.last.fm">Last.fm</a></span>',t+="</div>",t+='<div class="mdl-card__menu">',t+='<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" onclick="MapsService.getInfoWindow().close()">',t+='<i class="material-icons">clear</i>',t+="</button>",t+="</div>",t+="</div>",t=t.replace("@@name@@",e.title),t=t.replace("@@eventImage@@",e.image),t=t.replace("@@eventHeadliner@@",e.headliner),t=t.replace("@@attendance@@",e.attendance),t=t.replace("@@venueName@@",e.venue.name),t=t.replace("@@venueCity@@",e.venue.city),t=t.replace("@@venueCountry@@",e.venue.country)},n.selectMarker=function(e){google.maps.event.trigger(a[e],"click")},n.initializeMap=function(t){var n=new google.maps.LatLng(39.476,-6.372),a={center:n,zoom:3,disableDefaultUI:!0,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]};e=new google.maps.Map(document.getElementById("map-canvas"),a)},n.initializeInfoWindow=function(){t=new google.maps.InfoWindow,google.maps.event.addListener(t,"domready",function(){var e=$(".gm-style-iw"),t=e.prev();t.children(":nth-child(2)").css({display:"none"}),t.children(":nth-child(4)").css({display:"none"}),t.children(":nth-child(1)").attr("style",function(e,t){return t+"left: 76px !important;"}),t.children(":nth-child(3)").attr("style",function(e,t){return t+"left: 76px !important;"}),t.children(":nth-child(3)").find("div").children().css({"box-shadow":"rgba(72, 181, 233, 0.6) 0px 1px 6px","z-index":"1"}),t.children(":nth-child(3)").attr("style",function(e,t){return t+"margin: 0px; padding: 0px;"});var n=e.next();n.css({display:"none"})})}};ko.extenders.localStore=function(e,t){"use strict";var n=amplify.store(t)||e(),a=ko.computed({read:e,write:function(n){amplify.store(t,n),e(n)}}).extend({notify:"always"});return a(n),a};var Venue=function(e){"use strict";this.name=e.name||"",e.location&&(this.location={latitude:e.location["geo:point"]["geo:lat"],longitude:e.location["geo:point"]["geo:long"]}),this.street=e.location.street,this.city=e.location.city,this.country=e.location.country,this.postalcode=e.postalcode||"",this.website=e.website||""},Event=function(e){"use strict";this.title=e.title||"",this.website=e.website||"",this.date=e.startDate||"",this.image=e.image[3]["#text"]||"images/concert.jpg",e.venue&&(this.venue=new Venue(e.venue)),this.attendance=parseInt(e.attendance||0),this.headliner=e.artists.headliner||[]},Artist=function(e){"use strict";this.name=e.name||"",this.mbid=e.mbid||"",this.ontour=e.ontour||"0",this.image=e.image[2]["#text"]||"images/concert.jpg",this.bio=e.bio.summary||""},OnTheRoadVM=function(){"use strict";var e=this;e.xhrArtist=void 0,e.xhrEvents=void 0,e.xhrPlaces=void 0,e.currentArtist=ko.observable().extend({localStore:"OntheRoad-Current-Artist"}),e.eventList=ko.observableArray([]),e.totalPages=ko.observable(0),e.currentPage=ko.observable(0),e.searchText=ko.observable().extend({rateLimit:{method:"notifyWhenChangesStop",timeout:500},localStore:"OntheRoad-Search-Text"}),e.dateFilter=ko.observable("all"),e.loadEventsFromLastFm=function(t,n){if(t){e.xhrEvents&&e.xhrEvents.abort(),n&&1!==n||(e.eventList([]),e.totalPages(0),e.currentPage(0));var a="http://ws.audioscrobbler.com/2.0/?method=artist.getevents&api_key=091752a3717719e4d40441a0127c8914&format=json&autocorrect=1&limit=30&artist=@@artist@@&page=@@page@@";a=a.replace("@@artist@@",t).replace("@@page@@",n||"1"),e.xhrEvents=$.ajax({url:a,success:function(t){if(t.error)console.log(t.message);else if(t.events.event){var n=t.events.event,a=void 0!==t.events["@attr"]?Math.min(t.events["@attr"].perPage,t.events["@attr"].total):t.events.total;if(console.log(n),1===a)e.eventList.push(new Event(n)),e.totalPages(1),e.currentPage(1);else{for(var r=0;r<n.length;r++)e.eventList.push(new Event(n[r]));e.totalPages(t.events["@attr"].totalPages),e.currentPage(t.events["@attr"].page)}}},error:function(e){console.log(e.message),document.querySelector("#toastAPIError").show()},fail:function(e){console.log(e.message),document.querySelector("#toastAPIError").show()}})}},e.getArtistInfoFromLastFm=function(t){var n="http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&api_key=091752a3717719e4d40441a0127c8914&format=json&autocorrect=1&artist=@@artist@@";n=n.replace("@@artist@@",t),t&&(e.xhrArtist&&e.xhrArtist.abort(),e.xhrArtist=$.ajax({url:n,success:function(t){t.error?console.log(t.message):t.artist&&"Undefined"!==t.artist.name&&(e.currentArtist(new Artist(t.artist)),e.searchText(t.artist.name))},error:function(e){console.log(e.message)},fail:function(e){console.log(e.message)}}))},e.isThereArtist=ko.computed(function(){return e.currentArtist()instanceof Artist}),e.filteredEventList=ko.computed(function(){return ko.utils.arrayFilter(e.eventList(),function(t){var n=new Date,a=new Date(t.date);switch(e.dateFilter()){case"today":return a.getDay()===n.getDay();case"month":return a.getMonth()===n.getMonth();case"year":return a.getFullYear()===n.getFullYear();default:return!0}})}),e.markersList=ko.computed(function(){MapsService.clearMarkers(),ko.utils.arrayForEach(e.filteredEventList(),function(e){MapsService.getMarkers().push(MapsService.createMarker(e))}),MapsService.fitBounds()}),e.searchEvents=ko.computed(function(){""!==e.searchText()&&(e.loadEventsFromLastFm(e.searchText(),1),e.getArtistInfoFromLastFm(e.searchText()))}),e.isLastPage=function(){return e.currentPage()===e.totalPages()},e.loadNextPage=function(){e.currentPage()<e.totalPages()&&e.loadEventsFromLastFm(e.searchText(),parseInt(e.currentPage())+1)},e.selectMarker=function(t){var n=ko.utils.arrayIndexOf(e.filteredEventList(),t);MapsService.selectMarker(n)},e.showResultList=ko.observable(!0),e.updateResultList=ko.computed(function(){e.showResultList()?$("#results-list").show():$("#results-list").hide()})};$(function(){"use strict";ko.applyBindings(new OnTheRoadVM),MapsService.initializeMap(),MapsService.initializeInfoWindow(),$("#progress-bar").hide()});